<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <title>SKS Spider by sgrayban</title>

    <link rel="stylesheet" href="stylesheets/styles.css">
    <link rel="stylesheet" href="stylesheets/pygment_trac.css">
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
  </head>
  <body>
    <div class="wrapper">
      <header>
        <h1>SKS Spider</h1>
        <p>Tool to spider the PGP SKS keyserver mesh.</p>

        <p class="view"><a href="https://github.com/sgrayban/sks_spider">View the Project on GitHub <small>sgrayban/sks_spider</small></a></p>


        <ul>
          <li><a href="https://github.com/sgrayban/sks_spider/zipball/master">Download <strong>ZIP File</strong></a></li>
          <li><a href="https://github.com/sgrayban/sks_spider/tarball/master">Download <strong>TAR Ball</strong></a></li>
          <li><a href="https://github.com/sgrayban/sks_spider">View On <strong>GitHub</strong></a></li>
        </ul>
      </header>
      <section>
        <h1>sks_spider</h1>

<h1>Tool to spider the PGP SKS keyserver mesh.</h1>

<hr><p>To test my code status use the following URL:
<a href="https://travis-ci.org/sgrayban/sks_spider"><img src="https://secure.travis-ci.org/sgrayban/sks_spider.png?branch=master" alt="Build Status"></a></p>

<h2>Overview</h2>

<hr><p>If you don't know what PGP is or anything about the PGP keyservers, then
this tool is not for you.  Otherwise, read on.</p>

<p>This is a package which produces one binary, <code>sks_stats_daemon</code>.  This is a
web-server which goes to a seed SKS server, grabs stats, and spiders out
from there.</p>

<p>The resulting daemon should be set behind a front-end web-server such as
nginx, with the <code>/sks-peers</code> location dispatched to it.  If you run this
daemon listening on a publicly reachable port, or dispatch more of the URI
namespace to the daemon, you may have issues, as administrative URIs can
live outside of that prefix.</p>

<p>As well as a stats overview page, there is also an interface to grab lists
of IPs meeting various serving criteria; I use that to build DNS zones
automatically, from cron, as a client of this service.  The client was
unperturbed by the migration.</p>

<p>The original version was written in Python as a WSGI and grew organically.
This version is written in Golang (the Go programming language) and makes
fairly decent use of Go's concurrency features.  It uses well under a fifth
the total RAM, something similarly smaller in RSS, uses less CPU (when busy,
10% of an ancient CPU instead of all of one; when
"idle" is not sitting at the top of top(1) output, using fractionally more
CPU than a real idle process) and is <em>significantly</em> more responsive.  These
improvements are in part because of Golang and in very large part because of
the ugliness of the old code.  Python's good, I'm bad.</p>

<p>All the production serving interface features have now been copied across;
all that's left are some admin hooks which aren't really applicable (eg,
a list of Python threads for introspection).
Those other features should not significantly impact resource consumption.</p>

<h2>To-Do</h2>

<hr><ul>
<li>Preserve more errors for the front-page?</li>
<li>Look over the admin interfaces, probably want <code>/rescanz</code> back</li>
<li>If add rescanz, need locking around spider starting; can preserve spider
handle while at it, and make it possible to, eg kill an existing scan using
a random nonce to authenticate, where the nonce has to be retrieved from
the logfile.</li>
</ul><h2>Packages</h2>

<hr><p>I provide pre-built binaries for Linux/ELF x86Â (i686) (natively built on Debian) 32-bit-capable systems:</p>

<ol>
<li><a href="https://keyserver.borgnet.us/downloads/">https://keyserver.borgnet.us/downloads/</a></li>
<li><a href="https://bitbucket.org/sgrayban/sks_spider/downloads">https://bitbucket.org/sgrayban/sks_spider/downloads</a></li>
</ol><h2>Building</h2>

<hr><p>For the most part, <code>go get</code> should just work.</p>

<p>The exception is the btree support from <a href="https://github.com/runningwild/go-btree">https://github.com/runningwild/go-btree</a>
which is very nice, and written using generics, with the <code>gotgo</code>
pre-processor needed to emit a .go file.</p>

<p>Grab <a href="https://github.com/droundy/gotgo">https://github.com/droundy/gotgo</a> and put some go1 <code>// +build ignore</code>
magic into a couple of the benchmark files, and you'll be able to build
the <code>gotgo</code> and <code>gotimports</code> commands.</p>

<p>In the <code>go-btree</code> directory, run:</p>

<pre><code>gotgo -o btree.go btree.got string
</code></pre>

<p>There's probably a better way to sort out a namespace hierarchy which don't
expect only one instantiation of the generic, but I was grabbing a btree
library in passing and didn't investigate fully.</p>

<p>After that, the btree import will work and the code should build with:</p>

<pre><code>go build github.com/sgrayban/sks_spider/sks_stats_daemon.go
</code></pre>

<p>If you encounter problems, look at the <code>.travis.yml</code> file which is used
for running the Travis Continuous Integration tests:
    <a href="https://travis-ci.org/sgrayban/sks_spider">https://travis-ci.org/sgrayban/sks_spider</a>.
That assumes some other prep steps run automatically by Travis, but the test
log should show everything in context.</p>

<h2>Running</h2>

<hr><p>You can see the accepted parameters with the <code>-help</code> flag:</p>

<pre><code>sks_stats_daemon -help
</code></pre>

<p>You might run, as an unprivileged user:</p>

<pre><code>sks_stats_daemon -log-file /var/log/sks-stats.log
</code></pre>

<p>Note that this tool does not self-detach from the terminal: I prefer to leave
it where a supervising agent tool can easily watch it.  If you want it to
detach, then your OS should have available a wrapper command which will handle
that for you.</p>

<p>The log-file will need to be exist and be writable by that unprivileged
user (or be in a directory which that user can create new files in).</p>

<p>Note that the logging does not currently log all HTTP requests; that's the
responsibility of the front-end (for now?).  Actually, the logging isn't
production-grade.  It "logs", but that doesn't mean the logs have proven
themselves adequate at crunch time.</p>

<p>The horrible HTML templates (translated directly from my horrible Python
ones ... I'm <em>definitely</em> not a UI designer) expect a style-sheet and a
<code>favicon.ico</code> to be provided as part of the namespace, they're not served
by this daemon.</p>

<p>Yes, this is a toy program.  It's a useful toy, but definitely not a
shipping product.</p>

<p>My start-up script (OS-specific, not included) <code>touch</code>es and <code>chown</code>s
the log-file before starting the program.  It then runs, as the same
run-time user as is used for <code>sks</code> itself (for my convenience in user
management):</p>

<pre><code>sks_stats_daemon -log-file /var/log/sks-stats.log \
  -json-persist /var/sks/stats-persist.json \
  -started-file /var/sks/stats.started
</code></pre>

<p>The <code>-json-persist</code> flag causes <code>sks_stats_daemon</code> to register a handler
for <code>SIGUSR1</code>; receipt of that signal causes the current mesh to be written to
the named file (removing any previous content), before exiting.</p>

<p>The start-up script takes a <code>quickrestart</code> argument, which sends <code>SIGUSR1</code>,
waits for the process to disappear, then starts <code>sks_stats_daemon</code> once more.
It then waits for the <code>-started-file</code> flag-file to appear, then removes it
and exits.</p>

<h2>nginx configuration</h2>

<hr><p>It's as simple as:</p>

<pre><code>location /sks-peers {
    proxy_pass          http://127.0.0.1:8001;
    proxy_set_header    X-Real-IP $remote_addr;
}
</code></pre>

<p>In fact, you don't even need the X-Real-IP pass-through, but set it up now
and it'll be easier to deal with a future change which logs the origin IP.</p>

<h2>Apache configuration</h2>

<hr><pre><code>&lt;Location /sks-peers&gt;
ProxyPass http://127.0.0.1:8001/sks-peers
SetEnv force-proxy-request-1.0 1
SetEnv proxy-nokeepalive 1
&lt;/Location&gt;
</code></pre>

<h2>License</h2>

<hr><p>Apache 2.0.</p>

<p>Most people are nice and sane and in a world without subversion and lawyers,
this next bit wouldn't be necessary.  It's butt-covering, that's all.</p>

<p>If you send me a patch or a pull request, then by default:</p>

<ul>
<li>I will add you to a CONTRIBUTORS file</li>
<li>You are assumed to be implicitly granting a license to me for your work to
be distributed under the same license, as part of a larger work</li>
<li>You are assumed to have the authority to submit the modification
under these terms and are implicitly testifying to this by making the
submission.</li>
</ul><p>In other words: please don't be a jackass, contributions are expected to
contribute towards the codebase, not take away.  Thanks.</p>

<p>That's about it.<br>
-Phil
-Scott</p>
      </section>
      <footer>
        <p>This project is maintained by <a href="https://github.com/sgrayban">sgrayban</a></p>
        <p><small>Hosted on GitHub Pages &mdash; Theme by <a href="https://github.com/orderedlist">orderedlist</a></small></p>
      </footer>
    </div>
    <script src="javascripts/scale.fix.js"></script>
    
  </body>
</html>